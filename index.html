<!DOCTYPE html>

<html lang="en">
	<head>
		<title>Canvas Layers</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
		<!-- <script type="application/javascript" src="canvaslayers.js"></script> -->
		<!-- <script type="application/javascript">

			var container;
			
			function init(canvasId) {
				var canvas = document.getElementById(canvasId);
				container = new CanvasLayers.Container(canvas, true);

				document.getElementById("btnNewLayer").addEventListener('click', function() {
					addLayer("Sample Layer");
				});

				document.getElementById(canvasId).addEventListener('keydown', function(event) {
					if (event.code === 'Enter') {
						addLayer("Sample Layer Enter");
					}
				});

				container.redraw();	
			}

			var x = 0;
			var y = 0;

			function addLayer(name) {
				var layer = new CanvasLayers.Layer(0, 0, 500 - x + y, 500 - y + x);
				container.children.add(layer);
				
				layer.onRender = function (layer, rect, ctx) {
					ctx.fillStyle = 'rgb(' + x + ',' + y + ',' + (y + x / 2) + ')';
					ctx.fillRect(0, 0, 500 - x + y, 500 - y + x);
				};

				container.redraw();
				alert('New Layer with name: "' + name + '" added');
				
				x += 10;
				y += 10;

				console.log('rgb(' + x + ',' + y + ',' + (y + x / 2) + ')\n');
				console.log('# of childrens on container: ' + container.children.length);
			}
		</script> -->
	</head>
	
	<body>
		<div class="container text-center" style="max-width: 1100px">
			<div class="row mt-5">
				<div class="col">
					<button id="btnNewLayer" type="button" class="btn btn-outline-primary">New Layer (Square)</button>
					<button id="btnNewCircle" class="btn btn-outline-secondary">New Layer (Circle)</button>
					<button id="btnNewImage" class="btn btn-outline-secondary">New Image</button>
					<button id="btnClearLayers" type="button" class="btn btn-outline-success">Clear Layers</button>
					<button id="btnDisplayLayers" type="button" class="btn btn-outline-danger">Display Layers</button>
					<button id="btnHideLayer" type="button" class="btn btn-outline-warning">Hide Layer</button>
					<button id="btnShowLayer" type="button" class="btn btn-outline-info">Show Layer</button>
					<button id="btnSwapLayer" type="button" class="btn btn-outline-dark">Swap Layer</button>
				</div>
			</div>
			<div class="row mt-3">
				<div class="col">
					<canvas id="canvas" class="rounded" width="700" height="500" style="border: 1px solid black;"></canvas>
				</div>
			</div>
			<div class="row mt-3">
				<div class="col rounded" id="thumbnailContainer" style="max-width: 700px; margin: 0 auto; height: 100px; border: 1px solid black;">

				</div>
			</div>
		</div>
		<script type="module">
			import LayerContainer, { Layer } from './js/ModernCanvasLayer.js';

			let container = new LayerContainer("canvas", "2d");
			
			let btnNewLayer = document.getElementById("btnNewLayer");
			let btnNewCircle = document.getElementById("btnNewCircle");
			let btnNewImage = document.getElementById("btnNewImage");
			let btnClearLayers = document.getElementById("btnClearLayers");
			let btnToggleDisplayLayers = document.getElementById("btnDisplayLayers");
			let btnHideLayer = document.getElementById("btnHideLayer");
			let btnShowLayer = document.getElementById("btnShowLayer");
			let btnSwapLayer = document.getElementById("btnSwapLayer");

			let layerCount = 1;

			btnToggleDisplayLayers.addEventListener('click', function() {
				alert("Go to Console in DevTools to see the lists of layers");
				container.displayLayers(false);
			});

			function getRandomColor() {
				const letters = "0123456789ABCDEF";
				let color = "#";
				for (let i = 0; i < 6; i++) {
					color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}

			function getRandomPosition(min, max) {
				const x = Math.floor(Math.random() * (max - min + 1)) + min;
				const y = Math.floor(Math.random() * (max - min + 1)) + min;
				return { x, y };
			}

			function addMouseEventsToLayer(layerName) {
				console.log("Event Triggered");
				const selectedLayer = container.selectLayer(layerName);

				if (selectedLayer) {
					let isDragging = false;
					let offsetX, offsetY;

					// Event listeners for mouse events
					container._canvas.addEventListener("mousedown", function (e) {
						console.log("Mouse Down Triggered")
						const mouseX = e.clientX - container._canvas.getBoundingClientRect().left;
						const mouseY = e.clientY - container._canvas.getBoundingClientRect().top;

						if (
							mouseX >= selectedLayer._posX &&
							mouseX <= selectedLayer._posX + selectedLayer._width &&
							mouseY >= selectedLayer._posY &&
							mouseY <= selectedLayer._posY + selectedLayer._height
						) {
							// isDragging = true;
							// offsetX = mouseX - selectedLayer._posX;
							// offsetY = mouseY - selectedLayer._posY;
							const topLayer = container._layers.reduce((prevLayer, currentLayer) => {
								if (
									mouseX >= currentLayer._posX &&
									mouseX <= currentLayer._posX + currentLayer._width &&
									mouseY >= currentLayer._posY &&
									mouseY <= currentLayer._posY + currentLayer._height
								) {
									return prevLayer._index > currentLayer._index ? prevLayer : currentLayer;
								}
								return prevLayer;
							}, selectedLayer);

							if (topLayer === selectedLayer) {
								isDragging = true;
								offsetX = mouseX - selectedLayer._posX;
								offsetY = mouseY - selectedLayer._posY;
							}
						}
					});

					container._canvas.addEventListener("mousemove", function (e) {
						if (isDragging) {
							console.log("Mouse is Dragging")
							const mouseX = e.clientX - container._canvas.getBoundingClientRect().left;
							const mouseY = e.clientY - container._canvas.getBoundingClientRect().top;

							// Calculate the new position
							const newX = mouseX - offsetX;
							const newY = mouseY - offsetY;

							// Update the position while preserving the z-index
							selectedLayer._posX = newX;
							selectedLayer._posY = newY;

							// Redraw the canvas with the updated position and z-index
							container.displayLayers(true); // Pass true to indicate that the layers are sorted by z-index
						}
					});

					container._canvas.addEventListener("mouseup", function () {
						isDragging = false;
						console.log("Mouse Up Triggered")
					});
				}
				else {
					alert("No Selected Layer");
				}
			}

			btnNewLayer.addEventListener("click", function() {
				let newLayer = new Layer(getRandomPosition(Math.random(), container._canvas.height, Math.random(), container._canvas.width).x, getRandomPosition(Math.random(), container._canvas.height, Math.random(), container._canvas.width).y, "Layer " + layerCount, 300, 300, layerCount, getRandomColor(), 'black', 'square');
				container.addLayer(newLayer);
				newLayer.drawShape(container.get2DContext());

				let layers = container._layers;
				for (let i = 0; i < layers.length; i++) {
					addMouseEventsToLayer(layers[i]._name);
				}
				layerCount++;

				for (let layer of container._layers) {
					displayLayerThumbnail(layer, document.getElementById("thumbnailContainer"));
				}
			});

			btnNewCircle.addEventListener("click", function() {
				let newCircle = new Layer(getRandomPosition(Math.random(), container._canvas.height, Math.random(), container._canvas.width).x, getRandomPosition(Math.random(), container._canvas.height, Math.random(), container._canvas.width).y, "Layer " + layerCount, 150, 150, layerCount, getRandomColor(), 'black', 'circle');
				container.addLayer(newCircle);
				newCircle.drawShape(container.get2DContext());

				let layers = container._layers;
				for (let i = 0; i < layers.length; i++) {
					addMouseEventsToLayer(layers[i]._name);
				}
				layerCount++;
				
				for (let layer of container._layers) {
					displayLayerThumbnail(layer, document.getElementById("thumbnailContainer"));
				}
			});

			btnNewImage.addEventListener('click', function() {
				let newImage = new Layer(10, 10, "Image " + layerCount, 728, 1210, layerCount, null, null, null);
				container.addLayer(newImage);
				newImage.drawImage(container._ctx, './003.png');

				let layers = container._layers;
				for (let i = 0; i < layers.length; i++) {
					addMouseEventsToLayer(layers[i]._name);
				}
				layerCount++;
			});

			btnClearLayers.addEventListener('click', function() {
				let layers = container._layers;
				if (layers.length != 0) {
					let result = confirm(`Are you sure you want to clear layers?\nCurrent Layers: ${layers.length}`);
					if (result === true) {
						container._layers = [];
						container._ctx.clearRect(0, 0, container._canvas.width, container._canvas.height);
					}
				}
				else {
					alert("No layers to be removed");
				}
			});

			btnSwapLayer.addEventListener('click', function() {
				const layers = container._layers;
				for (let i = 1; i < layers.length; i++) {
					let fLayer = layers[i - 1];
					let sLayer = layers[i];
					container.swapIndex(fLayer, sLayer);
				}
				container.displayLayers(true);
			});
		</script>
	</body>
</html>