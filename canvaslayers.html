<html>
	<head>
		<title>Canvas Layers</title>
		<script type="application/javascript" src="canvaslayers.js"></script>
		<script type="application/javascript">

var container;
var layer1;
var layer2;
var layer3child1;
var timer;

var layer1dx = 1;
var layer1dy = 2;

var layer2dx = 2;
var layer2dy = -1;

var layer31dx = 1;
var layer31dy = 2;

var img;

function init(canvasId) {
	
	img = new Image();
	img.src = "mario.jpg";

	// Layer setup
	var canvas = document.getElementById(canvasId);
	container = new CanvasLayers.Container(canvas, true);
	
	layer1 = new CanvasLayers.Layer(10, 60, 60, 60);
	container.children.add(layer1);
	
	var layer1child1 = new CanvasLayers.Layer(0, 0, 30, 30);
	layer1.children.add(layer1child1);
	
	layer2 = new CanvasLayers.Layer(20, 20, 100, 100);
	container.children.add(layer2);
		
	var layer3 = new CanvasLayers.Layer(50, 50, 200, 200);
	layer3.setPermeable(true);
	container.children.add(layer3);
	
	layer3child1 = new CanvasLayers.Layer(0, 0, 60, 60);
	layer3.children.add(layer3child1);
		
	var layer3child2 = new CanvasLayers.Layer(0, 90, 200, 20);
	layer3.children.add(layer3child2);
	
	layer1.raiseToTop();
	
	// Layer rendering methods
	container.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.fillStyle = '#fff';
		context.fillRect(0, 0, 400, 400);
		context.closePath();
		context.restore();
	}
	
	layer1child1.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.fillStyle = '#0f0';
		context.fillRect(0, 0, 400, 400);
		
		context.strokeStyle = '#000'
		context.strokeRect(layer.getX(), layer.getY(), layer.getWidth(), layer.getHeight())
		
		context.closePath();
		context.restore();
	}
	
	layer1.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.fillStyle = 'rgba(10, 10, 10, 0.5)';
		context.fillRect(layer.getX() + 10, layer.getY() + 10, layer.getWidth(), layer.getHeight());
		
		context.strokeStyle = '#000'
		context.strokeRect(layer.getX(), layer.getY(), layer.getWidth(), layer.getHeight())
		
		context.closePath();
		context.restore();
	}
	
	layer2.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.strokeStyle = '#000'
		context.strokeRect(layer.getX(), layer.getY(), layer.getWidth(), layer.getHeight());
		
		context.drawImage(img, 0, 0);
		
		context.closePath();
		context.restore();
	}
	
	layer3.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.fillStyle = '#ff0';
		context.fillRect(0, 0, 400, 400);
		
		context.strokeStyle = '#000'
		context.strokeRect(layer.getX(), layer.getY(), layer.getWidth(), layer.getHeight())
		
		context.closePath();
		context.restore();
	}
	
	layer3child1.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.drawImage(img, 250, 140, layer.getWidth(), layer.getHeight(), layer.getX(), layer.getY(), layer.getWidth(), layer.getHeight());
		
		context.closePath();
		context.restore();
	}
	
	layer3child2.onRender = function(layer, rect, context) {
		context.save();
		context.beginPath();
		context.rect(rect.x, rect.y, rect.width, rect.height);
		context.clip();
		
		context.fillStyle = '#f00';
		context.fillRect(0, 0, 400, 400);
		context.closePath();
		context.restore();
	}
	
	timer = setInterval("changeScene()", 10);
}

function changeScene() {
	layer1.moveTo(layer1.rect.x + layer1dx, layer1.rect.y + layer1dy);
	
	if (layer1.rect.x + layer1.rect.width >= container.getWidth()) {
		layer1dx = -1;
	} else if (layer1.rect.x <= 0) {
		layer1dx = 1;
	}
	
	if (layer1.rect.y + layer1.rect.height >= container.getHeight()) {
		layer1dy = -2;
	} else if (layer1.rect.y <= 0) {
		layer1dy = 2;
	}
	
	layer2.moveTo(layer2.rect.x + layer2dx, layer2.rect.y + layer2dy);
	
	if (layer2.rect.x + layer2.rect.width >= container.getWidth()) {
		layer2dx = -2;
	} else if (layer2.rect.x <= 0) {
			layer2dx = 2;
		}
	
	if (layer2.rect.y + layer2.rect.height >= container.getHeight()) {
		layer2dy = -1;
	} else if (layer2.rect.y <= 0) {
		layer2dy = 1;
	}
	
	layer3child1.moveTo(layer3child1.rect.x + layer31dx, layer3child1.rect.y + layer31dy);
	
	if (layer3child1.rect.x >= layer3child1.getParent().getWidth()) {
		layer31dx = -1;
	} else if (layer3child1.rect.x <= -layer3child1.rect.width) {
		layer31dx = 1;
	}
	
	if (layer3child1.rect.y >= layer3child1.getParent().getHeight()) {
		layer31dy = -2;
	} else if (layer3child1.rect.y <= -layer3child1.rect.height) {
		layer31dy = 2;
	}
	
	container.redraw();
}

		</script>
	</head>
	
	<body onload="init('canvas')">
		<canvas id="canvas" width="400" height="400"></canvas>
	</body>
</html>